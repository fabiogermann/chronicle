name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Validate version matches tag
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          GRADLE_VERSION=$(grep -oP 'versionName\s*=\s*"\K[^"]+' app/build.gradle.kts)
          if [ "$TAG_VERSION" != "$GRADLE_VERSION" ]; then
            echo "❌ Version mismatch!"
            echo "   Tag version: $TAG_VERSION"
            echo "   Gradle version: $GRADLE_VERSION"
            exit 1
          fi
          echo "✅ Version matched: $TAG_VERSION"
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Decode and setup keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ ! -z "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > app/release-keystore.jks
            echo "KEYSTORE_FILE=release-keystore.jks" >> $GITHUB_ENV
          else
            echo "Warning: No keystore found. APK will be signed with debug key."
          fi
      
      - name: Run tests
        run: ./gradlew test
      
      - name: Build release APK
        env:
          KEYSTORE_FILE: ${{ env.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Rename APK
        run: |
          mkdir -p release-artifacts
          cp app/build/outputs/apk/release/app-release.apk release-artifacts/chronicle-${{ steps.get_version.outputs.VERSION }}.apk
      
      - name: Generate Changelog
        id: generate_changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -v "^${{ steps.get_version.outputs.VERSION }}$" | head -n 1)
          
          # If no previous tag exists, use v0.60.0 as baseline
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG="v0.60.0"
          fi
          
          echo "Generating changelog from $PREVIOUS_TAG to ${{ steps.get_version.outputs.VERSION }}"
          
          # Generate changelog with commit messages
          CHANGELOG=$(git log $PREVIOUS_TAG..${{ steps.get_version.outputs.VERSION }} --pretty=format:"- %s (%h)" --reverse)
          
          # Save changelog to file and output
          echo "$CHANGELOG" > changelog.txt
          
          # Create a multiline output for GitHub
          echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          {
            echo 'CHANGELOG<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: release-artifacts/*.apk
          body: |
            ## What's Changed
            
            ${{ steps.generate_changelog.outputs.CHANGELOG }}
            
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.generate_changelog.outputs.PREVIOUS_TAG }}...${{ steps.get_version.outputs.VERSION }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update CHANGELOG.md
        run: |
          CURRENT_VERSION=$(grep -oP 'versionName\s*=\s*"\K[^"]+' app/build.gradle.kts)
          RELEASE_DATE=$(date +%Y-%m-%d)
          
          # Read the generated changelog
          CHANGELOG_CONTENT=$(cat changelog.txt)
          
          # Create or update CHANGELOG.md
          if [ ! -f CHANGELOG.md ]; then
            # Create new CHANGELOG.md with header
            cat > CHANGELOG.md << 'HEADER_EOF'
# Changelog

All notable changes to this project will be documented in this file.

HEADER_EOF
          fi
          
          # Prepare the new changelog entry
          NEW_ENTRY="## [$CURRENT_VERSION] - $RELEASE_DATE

$CHANGELOG_CONTENT

"
          
          # Insert the new entry after the header
          if grep -q "^## \[" CHANGELOG.md; then
            # Insert before the first existing version entry
            sed -i "/^## \[/i\\$NEW_ENTRY" CHANGELOG.md
          else
            # Append to the end of the file
            echo "$NEW_ENTRY" >> CHANGELOG.md
          fi
      
      - name: Bump to next snapshot version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Parse current version
          CURRENT_VERSION=$(grep -oP 'versionName\s*=\s*"\K[^"]+' app/build.gradle.kts)
          CURRENT_CODE=$(grep -oP 'versionCode\s*=\s*\K[0-9]+' app/build.gradle.kts)
          
          # Calculate next patch version
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          NEXT_PATCH=$((VERSION_PARTS[2] + 1))
          NEXT_VERSION="${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.$NEXT_PATCH-SNAPSHOT"
          NEXT_CODE=$((CURRENT_CODE + 1))
          
          echo "Current version: $CURRENT_VERSION (code: $CURRENT_CODE)"
          echo "Next version: $NEXT_VERSION (code: $NEXT_CODE)"
          
          # Update build.gradle.kts
          sed -i "s/versionName = \"$CURRENT_VERSION\"/versionName = \"$NEXT_VERSION\"/" app/build.gradle.kts
          sed -i "s/versionCode = $CURRENT_CODE/versionCode = $NEXT_CODE/" app/build.gradle.kts
          
          # Commit and push (including CHANGELOG.md)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add app/build.gradle.kts CHANGELOG.md
          git commit -m "Bump version to $NEXT_VERSION and update CHANGELOG.md"
          git push origin HEAD:main
